<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.agri.platform.mapper.PestWarningMapper">
    <!-- 按处理状态查询预警 -->
    <select id="selectByHandleStatus" resultType="com.agri.platform.entity.PestWarning">
        SELECT * FROM pest_warning WHERE handle_status = #{handleStatus}
    </select>

    <!-- 按预警等级查询预警 -->
    <select id="selectByWarningLevel" resultType="com.agri.platform.entity.PestWarning">
        SELECT * FROM pest_warning WHERE warning_level = #{warningLevel}
    </select>
    
    <!-- 查询所有预警记录 -->
    <select id="selectAll" resultType="com.agri.platform.entity.PestWarning">
        SELECT * FROM pest_warning ORDER BY create_time DESC
    </select>
    
    <!-- update方法的实现 -->
    <update id="update" parameterType="com.agri.platform.entity.PestWarning">
        UPDATE pest_warning
        <set>
            <if test="handleStatus != null">handle_status = #{handleStatus},</if>
            <if test="warningReason != null">warning_reason = #{warningReason},</if>
            <if test="status != null">status = #{status},</if>
            <if test="updateTime != null">update_time = #{updateTime}</if>
        </set>
        WHERE warning_id = #{warningId}
    </update>
    
    <!-- selectById方法的实现 -->
    <select id="selectById" resultType="com.agri.platform.entity.PestWarning">
        SELECT * FROM pest_warning WHERE warning_id = #{warningId}
    </select>
    
    <!-- insert方法的实现 - 添加crop_type字段 -->
    <insert id="insert" parameterType="com.agri.platform.entity.PestWarning">
        INSERT INTO pest_warning (warning_id, land_id, warning_type, warning_level, 
                                handle_status, description, warning_reason, crop_type, create_time, update_time)
        VALUES (#{warningId}, #{landId}, #{warningType}, #{warningLevel}, 
                #{handleStatus}, #{description}, #{warningReason}, #{cropType}, #{createTime}, #{updateTime})
    </insert>
    
    <!-- deleteById方法的实现 -->
    <delete id="deleteById">
        DELETE FROM pest_warning WHERE warning_id = #{warningId}
    </delete>

    <update id="updateById" parameterType="com.agri.platform.entity.PestWarning">
        UPDATE pest_warning
        SET status = #{status}
        WHERE warning_id = #{warningId} <!-- 必须添加这个条件，否则会更新所有记录 -->
    </update>

    <!-- 根据预警ID更新状态（关键：加where条件，只更指定预警） -->
    <update id="updateStatusById" parameterType="com.agri.platform.entity.PestWarning">
        UPDATE pest_warning
        SET status = #{status}, update_time = NOW()
        WHERE warning_id = #{warningId} <!-- 必须加这个条件，否则更新所有预警 -->
    </update>
</mapper>