<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>智慧农业 - 用户中心</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#22c55e',
                        secondary: '#f97316',
                        danger: '#ef4444',
                        dark: '#1f2937',
                        light: '#f3f4f6'
                    },
                    fontFamily: { sans: ['Inter', 'system-ui', 'sans-serif'] }
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .card-shadow { box-shadow: 0 4px 20px rgba(0,0,0,.08); }
            .btn-primary { background-color: #22c55e; color: #fff; font-weight: 500; padding: 0.5rem 1rem; border-radius: 0.5rem; transition: all 0.3s; }
.btn-primary:hover { background-color: #1eb854; }
            .btn-outline { border: 1px solid #d1d5db; font-weight: 500; padding: 0.5rem 1rem; border-radius: 0.5rem; transition: all 0.3s; }
.btn-outline:hover { border-color: #22c55e; color: #22c55e; }
            .section-hidden { display: none !important; }
        }
    </style>
</head>

<body class="bg-gray-50 font-sans text-dark">
    <!-- 顶部导航 -->
    <header class="bg-white shadow-sm fixed top-0 left-0 right-0 z-50">
        <div class="container mx-auto px-4 py-3 flex items-center justify-between">
            <div class="flex items-center space-x-2">
                <i class="fa fa-leaf text-primary text-2xl"></i>
                <h1 class="text-xl font-bold">智慧农业种植监控系统</h1>
            </div>
            <div class="flex items-center space-x-4">
                <span class="hidden md:inline-block text-sm text-gray-600" id="current-time"></span>
                <div class="flex items-center space-x-2">
                    <img src="https://picsum.photos/id/1005/40/40" alt="用户头像" class="w-8 h-8 rounded-full object-cover">
                    <span class="text-sm font-medium" id="top-username">游客</span>
                </div>
                <button id="logout-btn" class="btn-outline text-sm">退出</button>
            </div>
        </div>
    </header>

    <!-- 主内容区 -->
    <div class="container mx-auto px-4 pt-24 pb-16 flex flex-col md:flex-row gap-6">
        <!-- 左侧导航 -->
        <aside class="md:w-64 bg-white rounded-xl card-shadow p-4 flex-shrink-0">
            <nav class="space-y-1">
                <a href="#login" class="nav-active flex items-center space-x-3 px-4 py-3 rounded-lg"><i
                        class="fa fa-sign-in"></i><span>用户登录</span></a>
                <a href="#register" class="flex items-center space-x-3 px-4 py-3 rounded-lg hover:bg-gray-50"><i
                        class="fa fa-user-plus"></i><span>用户注册</span></a>
                <a href="#profile" class="flex items-center space-x-3 px-4 py-3 rounded-lg hover:bg-gray-50"><i
                        class="fa fa-user-circle"></i><span>完善信息</span></a>
                <a href="#role" class="flex items-center space-x-3 px-4 py-3 rounded-lg hover:bg-gray-50"><i
                        class="fa fa-users"></i><span>角色权限</span></a>
            </nav>
        </aside>

        <!-- 右侧内容区 -->
        <main class="flex-1 space-y-8">
            <!-- 登录 -->
            <section id="login" class="bg-white rounded-xl card-shadow p-6 section-hidden">
                <h2 class="text-xl font-bold mb-4">用户登录</h2>
                <form id="login-form" class="max-w-md space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">登录方式</label>
                        <select id="login-type" title="登录方式"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50">
                            <option value="USERNAME">用户名</option>
                            <option value="EMAIL">邮箱</option>
                            <option value="PHONE">手机号</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">账号</label>
                        <input type="text" id="login-account" required placeholder="请输入账号"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">密码</label>
                        <input type="password" id="login-pwd" required placeholder="请输入密码"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50">
                    </div>
                    <button type="submit" class="btn-primary w-full">登录</button>
                </form>
            </section>

            <!-- 注册 -->
            <section id="register" class="bg-white rounded-xl card-shadow p-6 section-hidden">
                <h2 class="text-xl font-bold mb-4">用户注册</h2>
                <form id="reg-form" class="max-w-md space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">注册方式</label>
                        <select id="reg-type" title="注册方式"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50">
                            <option value="USERNAME">用户名</option>
                            <option value="EMAIL">邮箱</option>
                            <option value="PHONE">手机号</option>
                        </select>
                    </div>
                    <div id="reg-account-group">
                        <label class="block text-sm font-medium text-gray-700 mb-1">账号</label>
                        <input type="text" id="reg-account" required placeholder="请输入账号"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50">
                    </div>
                    <div id="reg-code-group" class="hidden">
                        <label class="block text-sm font-medium text-gray-700 mb-1">验证码</label>
                        <div class="flex space-x-2">
                            <input type="text" id="reg-code" placeholder="请输入验证码"
                                class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50">
                            <button type="button" id="send-code" class="btn-outline">发送验证码</button>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">密码</label>
                        <input type="password" id="reg-pwd" required placeholder="请输入密码"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">确认密码</label>
                        <input type="password" id="reg-pwd2" required placeholder="请再次输入密码"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50">
                    </div>
                    <button type="submit" class="btn-primary w-full">注册</button>
                </form>
            </section>

            <!-- 完善信息 -->
            <section id="profile" class="bg-white rounded-xl card-shadow p-6 section-hidden">
                <h2 class="text-xl font-bold mb-4">完善用户信息</h2>
                <form id="profile-form" class="max-w-md space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">用户名</label>
                        <input type="text" id="prof-username" placeholder="选填"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">邮箱</label>
                        <input type="email" id="prof-email" placeholder="选填"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">手机号</label>
                        <input type="tel" id="prof-phone" placeholder="选填"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50">
                    </div>
                    <button type="submit" class="btn-primary">保存</button>
                </form>
            </section>

            <!-- 角色权限 -->
            <section id="role" class="bg-white rounded-xl card-shadow p-6 section-hidden">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold">角色与权限管理</h2>
                    <div class="space-x-2">
                        <button id="add-role-btn" class="btn-primary text-sm">添加角色</button>
                        <button id="add-perm-btn" class="btn-outline text-sm">添加权限</button>
                    </div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div>
                        <h3 class="font-medium mb-2">用户-角色</h3>
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500">用户名</th>
                                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500">当前角色</th>
                                    <!-- <th class="px-3 py-2 text-left text-xs font-medium text-gray-500">操作</th> -->
                                </tr>
                            </thead>
                            <tbody id="user-role-tbody" class="bg-white divide-y divide-gray-200"></tbody>
                        </table>
                    </div>
                    <div>
                        <h3 class="font-medium mb-2">权限列表</h3>
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500">权限</th>
                                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500">操作</th>
                                </tr>
                            </thead>
                            <tbody id="perm-tbody" class="bg-white divide-y divide-gray-200"></tbody>
                        </table>
                    </div>
                </div>
                <div class="mt-6">
                    <h3 class="font-medium mb-2">为用户分配角色</h3>
                    <div class="flex space-x-2">
                        <input type="text" id="grant-user" placeholder="用户ID"
                            class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50">
                        <input type="text" id="grant-role" placeholder="角色名"
                            class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50">
                        <button id="grant-btn" class="btn-primary">分配</button>
                    </div>
                </div>
                <div class="mt-4">
                    <h3 class="font-medium mb-2">为角色绑定权限</h3>
                    <div class="flex space-x-2">
                        <input type="text" id="bind-role" placeholder="角色名"
                            class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50">
                        <input type="text" id="bind-perm" placeholder="权限名"
                            class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50">
                        <button id="bind-btn" class="btn-primary">绑定</button>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- 页脚 -->
    <footer class="bg-white border-t border-gray-200 py-4">
        <div class="container mx-auto px-4 text-center text-sm text-gray-500">
            <p>© 2025 智慧农业种植监控系统 - 版权所有</p>
        </div>
    </footer>

    <script>
        /* ---------- 通用提示 ---------- */
        function toast(msg, bg = 'bg-green-500') {
            const box = document.createElement('div');
            box.className = `fixed top-5 right-5 text-white px-4 py-2 rounded shadow-lg ${bg} transition-opacity duration-300`;
            box.textContent = msg;
            document.body.appendChild(box);
            setTimeout(() => box.remove(), 2500);
        }
        /* ---------- 通用工具 ---------- */
        const $api = async (url, opts = {}) => {
            const resp = await fetch(url, { ...opts, headers: { 'Content-Type': 'application/json', ...opts.headers } });
            if (!resp.ok) throw new Error(await resp.text());
            return resp.json();
        };
        const showToast = msg => alert(msg); // 课程设计够用

        /* ---------- 导航切换 ---------- */
        const navs = document.querySelectorAll('aside nav a');
        const sections = document.querySelectorAll('main section');
        navs.forEach(n => n.addEventListener('click', e => {
            e.preventDefault();
            const id = n.getAttribute('href').slice(1);
            navs.forEach(x => x.classList.remove('nav-active'));
            n.classList.add('nav-active');
            sections.forEach(s => s.classList.add('section-hidden'));
            document.getElementById(id).classList.remove('section-hidden');
        }));
        // 默认显示登录
        navs[0].click();

        /* ---------- 顶部时间 ---------- */
        const tick = () => document.getElementById('current-time').textContent = new Date().toLocaleString('zh-CN');
        tick(); setInterval(tick, 1000);

        /* ---------- 登录 ---------- */
        document.getElementById('login-form').addEventListener('submit', async e => {
            e.preventDefault();
            const type = document.getElementById('login-type').value;
            const login = document.getElementById('login-account').value;
            const pwd = document.getElementById('login-pwd').value;
            try {
                const res = await $api('/api/user/login', { method: 'POST', body: JSON.stringify({ login, password: pwd, type, ip: '' }) });
                localStorage.setItem('uid', res.userId);
                localStorage.setItem('uname', res.username);
                // showToast('登录成功');fetch('/api/user/login'
                toast('登录成功');
                document.getElementById('top-username').textContent = res.username;
                // 可选：自动跳转到“角色权限”页（想留在这页就注释掉）
                // navs[3].click();

                // TODO 修改成登录成功后跳转到业务首页
                // location.href = 'index.html'; // 回业务首页
            } catch (e) {
                // showToast('登录失败：' + e.message); 
                toast('登录失败：' + e.message, 'bg-red-500');
            }
        });

        /* ---------- 注册 ---------- */
        const regType = document.getElementById('reg-type');
        const accountGroup = document.getElementById('reg-account-group');
        const codeGroup = document.getElementById('reg-code-group');
        regType.addEventListener('change', () => {
            const t = regType.value;
            codeGroup.classList.toggle('hidden', t !== 'EMAIL');
        });
        document.getElementById('send-code').addEventListener('click', async () => {
            const email = document.getElementById('reg-account').value;
            if (!email) return showToast('请先输入邮箱');
            try {
                await $api('/api/verify-code/send?target=' + email + '&type=EMAIL', { method: 'POST' });
                showToast('验证码已发送');
            } catch (e) { showToast('发送失败：' + e.message); }
        });
        document.getElementById('reg-form').addEventListener('submit', async e => {
            e.preventDefault();
            const t = regType.value;
            const login = document.getElementById('reg-account').value;
            const pwd = document.getElementById('reg-pwd').value;
            const pwd2 = document.getElementById('reg-pwd2').value;
            if (pwd !== pwd2) return showToast('两次密码不一致');
            const code = t === 'EMAIL' ? document.getElementById('reg-code').value : '';
            try {
                await $api('/api/user/register', { method: 'POST', body: JSON.stringify({ type: t, login, password: pwd, verifyCode: code }) });
                showToast('注册成功，请登录');
                regType.value = 'USERNAME'; accountGroup.querySelector('input').value = '';
                codeGroup.querySelector('input').value = ''; document.getElementById('reg-pwd').value = ''; document.getElementById('reg-pwd2').value = '';
                navs[0].click(); // 切到登录
            } catch (e) { showToast('注册失败：' + e.message); }
        });

        /* ---------- 退出 ---------- */
        document.getElementById('logout-btn').addEventListener('click', () => {
            localStorage.removeItem('uid');
            localStorage.removeItem('uname');
            showToast('已退出');
            location.reload();
        });

        /* ---------- 完善信息 ---------- */
        document.getElementById('profile-form').addEventListener('submit', async e => {
            e.preventDefault();
            const uid = localStorage.getItem('uid');
            if (!uid) return showToast('请先登录');
            const dto = {
                userId: uid,
                username: document.getElementById('prof-username').value,
                email: document.getElementById('prof-email').value,
                phoneNumber: document.getElementById('prof-phone').value
            };
            try {
                const resp = await fetch('/api/user/update', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(dto)
                });
                console.log('update status:', resp.status);
                if (resp.ok) {                 // 204 也是 ok
                    toast('保存成功');
                } else {
                    toast('保存失败：' + resp.status, 'bg-red-500');
                }
                // showToast('保存成功');
            } catch (e) { showToast('保存失败：' + e.message); }
            console.log('update status:', resp.status);
            const text = await resp.text();
            console.log('update body:', text);   // 看看到底返回了什么
        });

        /* ---------- 角色权限 ---------- */
        async function loadUserRoles() {
            /* ====== 用户-角色 ====== */
            try {
                const list = await $api('/api/user/user-roles');
                const utbody = document.getElementById('user-role-tbody');
                utbody.innerHTML = list.map(r => `
            <tr>
                <td class="px-3 py-2 text-sm">${r.userId}</td>
                <td class="px-3 py-2 text-sm">${r.username}</td>
                <td class="px-3 py-2 text-sm">${r.roleName}</td>
                <td class="px-3 py-2 text-sm space-x-1">
                    <button class="text-primary hover:underline text-xs" onclick="changeRole('${r.userId}')">更换角色</button>
                </td>
            </tr>`).join('');
            } catch (e) {
                toast('用户-角色加载失败：' + e.message);
            }

            /* ====== 系统权限 ====== */
            try {
                const perms = await fetch('/api/user/permissions').then(r => r.ok ? r.json() : Promise.reject(r));
                const ptbody = document.getElementById('perm-tbody');
                ptbody.innerHTML = perms.map(p => `
            <tr>
                <td class="px-3 py-2 text-sm">${p}</td>
                <td class="px-3 py-2 text-sm space-x-1">
                    <button class="text-primary hover:underline text-xs" onclick="delPerm('${p}')">删除</button>
                </td>
            </tr>`).join('');
            } catch (e) {
                toast('权限加载失败：' + e.message);
            }
        }
        document.getElementById('add-role-btn').addEventListener('click', async () => {
            const name = prompt('请输入新角色名');
            if (!name) return;
            try {
                await $api('/api/user/role?roleName=' + name + '&description=', { method: 'POST' });
                showToast('添加成功'); loadUserRoles();
            } catch (e) { showToast('添加失败：' + e.message); }
        });
        document.getElementById('add-perm-btn').addEventListener('click', async () => {
            const name = prompt('请输入新权限名');
            if (!name) return;
            try {
                await $api('/api/user/permission?permissionName=' + name + '&description=', { method: 'POST' });
                showToast('添加成功'); loadUserRoles();
            } catch (e) { showToast('添加失败：' + e.message); }
        });
        document.getElementById('grant-btn').addEventListener('click', async () => {
            const uid = document.getElementById('grant-user').value;
            const rname = document.getElementById('grant-role').value;
            if (!uid || !rname) return showToast('请输入用户ID和角色名');
            const resp = await fetch('/api/user/user-role?userId=' + uid + '&roleName=' + rname, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });
            if (resp.ok) {
                toast('分配成功');
                loadUserRoles(); // 刷新列表
            } else {
                toast('分配失败：' + resp.status, 'bg-red-500');
            }
        });
        document.getElementById('bind-btn').addEventListener('click', async () => {
            const rname = document.getElementById('bind-role').value;
            const pname = document.getElementById('bind-perm').value;
            if (!rname || !pname) return showToast('请输入角色名和权限名');
            const resp = await fetch('/api/user/role-permission?roleName=', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });
            if (resp.ok) {                 // 只判状态
                toast('绑定成功');
            } else {
                toast('绑定失败：' + resp.status, 'bg-red-500');
            }
        });
        async function delRole(id) {
            if (!confirm('确定删除该角色？')) return;
            try {
                await $api('/api/user/role?roleName=' + id, { method: 'DELETE' });
                showToast('删除成功'); loadUserRoles();
            } catch (e) { showToast('删除失败：' + e.message); }
        }
        async function delPerm(name) {
            if (!confirm('确定删除该权限？')) return;
            try {
                await $api('/api/user/permission?permissionName=' + name, { method: 'DELETE' });
                showToast('删除成功'); loadUserRoles();
            } catch (e) { showToast('删除失败：' + e.message); }
        }
        // 首次进入角色页加载数据
        navs[3].addEventListener('click', loadUserRoles);
    </script>
</body>

</html>